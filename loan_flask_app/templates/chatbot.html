{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm p-4">
      <h3>Chatbot Assistant</h3>
      <p class="text-muted">Type <code>Yes</code> to begin. The assistant will ask you questions step-by-step and then run a prediction.</p>
      <div id="chatWindow" class="chat-window border rounded p-3 mb-3" style="height:320px; overflow:auto; background:#fafafa;">
        <div class="assistant-msg mb-2"><strong>Assistant:</strong> Hi! Type <em>Yes</em> when you're ready to begin.</div>
      </div>

      <form id="chatForm">
        <div class="input-group">
          <input id="userInput" type="text" class="form-control" placeholder="Type your answer..." autocomplete="off">
          <button class="btn btn-primary" type="submit">Send</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card p-3 shadow-sm">
      <h5>How it works</h5>
      <p>Sequential question flow. At the end you'll see an approval/rejection message based on the model.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function(){
  const chatWindow = document.getElementById("chatWindow");
  const chatForm = document.getElementById("chatForm");
  const userInput = document.getElementById("userInput");

  function appendMessage(who, text){
    const div = document.createElement("div");
    div.className = (who === "user") ? "user-msg mb-2 text-end" : "assistant-msg mb-2";
    div.innerHTML = "<strong>"+(who==="user" ? "You" : "Assistant")+":</strong> " + text;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  chatForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const val = userInput.value.trim();
    if(!val) return;
    appendMessage("user", val);
    userInput.value = "";
    try{
      const resp = await fetch(window.location.pathname, {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: new URLSearchParams({ user_input: val })
      });
      const data = await resp.json();
      appendMessage("assistant", data.reply);
      if(data.step === "done"){
        const restart = document.createElement("div");
        restart.className = "mt-2";
        restart.innerHTML = '<button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Start Over</button>';
        chatWindow.appendChild(restart);
      }
    }catch(err){
      appendMessage("assistant", "Error contacting server. Try again.");
    }
  });
});
</script>
{% endblock %}
